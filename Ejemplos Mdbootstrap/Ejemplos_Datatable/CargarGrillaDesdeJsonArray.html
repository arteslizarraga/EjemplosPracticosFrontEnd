<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Sistema de definici&oacute;n de Programas Formativos: M&oacute;dulos de Poblamiento del MCTP</title>
    <link rel="shortcut icon" href="https://www.inacap.cl/web/template-aplicaciones/img/favicon.ico" />
    <link rel="stylesheet" href="https://www.inacap.cl/web/template-aplicaciones/css/mdb.min.css">
</head>
<body id="appBody" class="d-flex flex-column">

    <div class="page-content">

        <div class="navbar-overlay"></div>

        <div id="menuContent">
            
            <!-- Loading Overlay -->
            <div class="loading-backdrop" id="loadingOverlay">
                <div class="loading-circle">
                    <div class="preloader-wrapper big active"><div class="spinner-layer spinner-white-only"><div class="circle-clipper left"><div class="circle"></div></div><div class="gap-patch"><div class="circle"></div></div><div class="circle-clipper right"><div class="circle"></div></div></div></div>
                </div>
            </div>
            <header class="header">

                <div class="header-container">

                    <!--Logo-->
                    <div class="header-logo">
                        <a href="https://www.inacap.cl">
                            <img src="https://www.inacap.cl/web/template-aplicaciones/img/isotipo.png" alt="INACAP" class="logo-mobile">
                            <img src="https://www.inacap.cl/web/template-aplicaciones/img/logo-inacap.png" alt="INACAP" class="logo">
                        </a>
                    </div>

                    <!--Titulo, recuerda que tambien debes reemplazar el nombre en el script m&aacute;s abajo-->
                    <div class="header-title">
                        <h1 id="title">
                            <a href="#">Título</a>
                        </h1>
                    </div>

                    <!--Datos del Usuario-->
                    <div class="user-info">

                        <div class="user-name mr-4">
                            <p> Ejemplo Nombre </p>
                        </div>

                        <!-- Iconos encabezado - Mobile -->
                        <div class="user-mobile-menu user-button dropdown dropdown-toggle" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <i class="material-icons">more_vert</i>

                            <div class="dropdown-menu dropdown-menu-right">
                                <p class="dropdown-user-name">Colaborador X</p>
                                <p class="dropdown-title dropdown-title--border">Accesibilidad</p>
                                <ul class="accesibility-menu">
                                    <li class="accesibility-menu__item">
                                        <div class="d-flex align-items-center justify-content-between" onclick="darkMode();">
                                            <span class="tipo-de-modo">Modo Oscuro</span>
                                            <div class="d-flex justify-content-center">
                                                <span>
                                                    <i class="material-icons">brightness_medium</i>
                                                </span>
                                            </div>
                                        </div>
                                    </li>
                                    <li class="accesibility-menu__item">
                                        <div class="d-flex align-items-center justify-content-between">
                                            <span>Tama&ntilde;o de letra</span>
                                            <div class="d-flex justify-content-center">
                                                <span tabindex="0" role="button" class="btnDecrease btn btn-round btn-fonts btn-secondary d-flex align-items-center justify-content-center waves-effect waves-light">
                                                    <i class="material-icons">remove</i>
                                                </span>
                                                <span tabindex="0" role="button" class="btnEnlarge btn btn-round btn-fonts btn-default d-flex align-items-center justify-content-center ml-2 mr-0 waves-effect waves-light">
                                                    <i class="material-icons">add</i>
                                                </span>
                                            </div>
                                        </div>
                                    </li>
                                </ul>

                                <!--- Cerrar Sesi&oacute;n-->
                                <p class="dropdown-title dropdown-title--border">Cuenta</p>
                                <ul class="accesibility-menu">
                                    <li class="accesibility-menu__item">
                                        <div class="d-flex align-items-center justify-content-between">
                                            <span id="tipo-de-modo">Cerrar Sesi&oacute;n</span>
                                            <div class="d-flex justify-content-center">
                                                <span>
                                                    <i class="material-icons">exit_to_app</i>
                                                </span>
                                            </div>
                                        </div>
                                    </li>
                                </ul>

                            </div>

                        </div>
                        <!-- Iconos encabezado - Mobile -->

                        <!-- Iconos encabezado - Escritorio-->
                        <div class="user-desktop-icons">

                            <div class="user-accesibility user-button dropdown dropdown-toggle" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">

                                <i class="material-icons ">accessibility</i>

                                <div class="dropdown-menu dropdown-menu-right">
                                    <p class="dropdown-title">Accesibilidad</p>
                                    <ul class="accesibility-menu">
                                        <li class="accesibility-menu__item">
                                            <div class="d-flex align-items-center justify-content-between" onclick="darkMode();">
                                                <span class="tipo-de-modo">Modo Oscuro</span>
                                                <div class="d-flex justify-content-center">
                                                    <span>
                                                        <i class="material-icons">brightness_medium</i>
                                                    </span>
                                                </div>
                                            </div>
                                        </li>
                                        <li class="accesibility-menu__item">
                                            <div class="d-flex align-items-center justify-content-between">
                                                <span>Tama&ntilde;o de letra</span>
                                                <div class="d-flex justify-content-center">
                                                    <span tabindex="0" role="button" class="btnDecrease btn btn-round btn-fonts btn-secondary d-flex align-items-center justify-content-center waves-effect waves-light"><i class="material-icons">remove</i></span>
                                                    <span tabindex="0" role="button" class="btnEnlarge btn btn-round btn-fonts btn-default d-flex align-items-center justify-content-center ml-2 mr-0 waves-effect waves-light"><i class="material-icons">add</i></span>
                                                </div>
                                            </div>
                                        </li>
                                    </ul>
                                </div>

                            </div>

                            <div class="user-logout user-button">
                                <a href="#"><i class="material-icons">exit_to_app</i></a>
                            </div>

                        </div>
                        <!-- Iconos encabezado - Escritorio-->

                    </div>
                </div>

            </header>
        </div>
        <main class="container">
            <section>

                <div class="card">

                    <div class="card-header">
                        <div class="row">
                            <div class="col-12 d-flex align-items-end justify-content-between">
                                <h4 class="float-left heading h4-responsive mb-0">Ejemplo Grilla</h4>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">

                            <div class="col col-md-6 d-flex justify-content-start">

                                <button type="button" onclick="agregarRegistro()" class="btn btn-default waves-effect waves-light">
                                    <span>Agregar Nuevo</span>
                                </button>
                            </div>
                            
                            <div class="col-12">
                                <br/>

                                <table id="TablaPrincipal" class="datatables table table-hover table-striped table-bordered m-0" width="100%">
                                    <thead>
                                      <tr>
                                        <th>Correlativo</th>
                                        <th>Prelación</th>
                                        <th>Nombre</th>
                                        <th>Descripción</th>
                                        <th>Fecha</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                      </tr>
                                    </thead>
                                    <tbody>
                  
                                    </tbody>
                                </table> 
                            </div>
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="row py-2 flex-row">
                      
                          <div class="col col-md-6  d-flex justify-content-start">

                            <button type="button" onclick="mostrarParamSQL()" class="btn btn-outline waves-effect waves-light">
                                <span>Imprimir parámetro SP</span>
                            </button>
                          </div>
                          <div class="col col-md-6 d-flex justify-content-end">
        
                            <button type="button" onclick="limpiarDatos()" class="btn btn-outline waves-effect waves-light">
                                <span>Limpiar Datos</span>
                            </button>

                            <button type="button" onclick="alert(JSON.stringify(datos))" class="btn btn-default waves-effect waves-light">
                              <span>Mostrar Datos</span>
                            </button>
                        
                          </div>
                        </div>
                    </div>

                </div>

            </section>
        </main>
    </div>

    <footer class="page-footer">
        <div class="container py-3">
            <div class="d-flex align-items-center justify-content-center justify-content-md-start">
                <div class="logo-gst">
                    <img src="http://www.inacap.cl/web/template-aplicaciones/img/logo-gst.png" alt="">
                </div>
                <span class="pl-2 pl-md-4">Gerencia de Sistemas y Tecnolog&iacute;as</span>
            </div>
        </div>
    </footer>


    <!-- SCRIPTS -->
    <script src="https://www.inacap.cl/web/template-aplicaciones/js/jquery-3.3.1.min.js"></script>
    <!-- Bootstrap tooltips -->
    <script src="https://www.inacap.cl/web/template-aplicaciones/js/popper.min.js"></script>
    <!-- Bootstrap core JavaScript -->
    <script src="https://www.inacap.cl/web/template-aplicaciones/js/bootstrap.min.js"></script>
    <!-- MDB core JavaScript -->
    <script src="https://www.inacap.cl/web/template-aplicaciones/js/mdb.min.js"></script>

    <script src="http://www.inacap.cl/web/template-aplicaciones/js/chosen.jquery.js"></script>

    <script src="https://www.inacap.cl/web/template-aplicaciones/js/datepicker.js"></script>
    
    <script src="http://www.inacap.cl/web/template-aplicaciones/js/datatables.min.js"></script>

    <script>

        // Activar selects
        $(".chosen-select").chosen({ disable_search_threshold: 10, no_results_text: "Sin Resultados para: ", width: "100%" });
        $(".mdb-select").material_select();

        let datos = obtenerDatos(); 
        alCargarPagina();

        function mostrarParamSQL()
        {
            let cadena = JSON.stringify(datos).split("\"").join("''");
            console.log(cadena);
        }
        
        async function alCargarPagina()
        {
            await construirGrillaPerfilesOcupacionalesCualificacion(datos);
            definirInputsGrilla();
        }

        async function agregarRegistro()
        {
            let prelacion = (datos.length > 0) ? (Math.max(...datos.map(o => o.prelacion)) + 1) : 1;
            let fechaHoy = new Date().toJSON().slice(0,10).split("-").reverse().join("-");  // "28-12-2022"
            datos.push({ ncorr: null, prelacion, nombre: `Probando ${prelacion}`, descripcion: `Probando descripción ${prelacion}`, fecha: fechaHoy, estado: "Activo" });

            await construirGrillaPerfilesOcupacionalesCualificacion(datos);
            definirInputsGrilla();
        }

        async function limpiarDatos()
        {
            datos = obtenerDatos(); 
            await construirGrillaPerfilesOcupacionalesCualificacion(datos);
            definirInputsGrilla();
        }

        function definirInputsGrilla()
        {
            Array.from($("#TablaPrincipal").DataTable().rows({ filter: "applied", page: "current" }).data()).forEach(x => 
            {
                let registro = datos.find(y => y.prelacion == x.prelacion);
                let txtFecha = $(`#fecha_${x.prelacion}`);

                if(txtFecha.data("datepicker") == null)  // Si no ha sido inicializado
                {
                    txtFecha.datepicker({ 
                        language: "es", 
                        dateFormat: "dd-mm-yyyy",
                        autoClose: true,
                        onSelect: (e) => {
                            registro.fecha = e;
                            console.log(registro);
                        } 
                    });
                }

                llenarSelect({ 
                    selectedValue: x.estado,
                    querySelector: `#estado_${x.prelacion}`, 
                    data: [{codigo: "Activo", descripcion: "Activo"}, {codigo: "Inactivo", descripcion: "Inactivo"}],
                    onchange: () => {
                        registro.estado = $(`#estado_${x.prelacion}`).val();
                        console.log(registro);
                    }
                });

                $(`#estado_${x.prelacion}`).chosen({ disable_search_threshold: 10, no_results_text: "Sin Resultados para: ", width: "100%" });
            });
        }

        function construirGrillaPerfilesOcupacionalesCualificacion(datosRecibidos)
        {
            showLoading();

            datosRecibidos.sort((a, b) => b.prelacion - a.prelacion);   // Ordena por prelacion desc

            return new Promise((resolve, reject) =>
            {
                $("#TablaPrincipal").DataTable({
                    data: datosRecibidos,
                    destroy: true,
                    pageLength: 5,
                    dom: '<"top top-grey"<"dataTables_actions"f>> <t> <"bottom mt-2 d-flex align-items-center justify-content-between flex-wrap"<"d-flex" il>p>',
                    //scrollY: "60vh",
                    //"scrollX": true,  // Si la tabla tiene poco tamaño hacia el lado, esto hace que se vea pequeña
                    //lengthMenu: [[10, 20, 30], [10, 20, 30]],
                    bLengthChange: false, // Oculta el select de registros por página
                    columnDefs: [
                        //{ "width": "260px", "targets": 4 }  // Ancho de la columna acciones
                    ],
                    aaSorting: [],
                    processing: true,
                    //serverSide: true, 
                    filter: true,
                    orderMulti: false,
                    responsive: true,
                    fnDrawCallback: () => {
                        hideLoading();
                        resolve(true)
                    },
                    columns: [
                        { data: "ncorr", "className": "text-nowrap", "searchable": true, "sortable": true, "render": (data, type, row, meta) => row.ncorr ?? "No tiene" },
                        { data: "prelacion", "className": "text-nowrap", "searchable": true, "sortable": true },
                        { data: "nombre", "className": "text-nowrap", "searchable": true, "sortable": true },
                        { data: "descripcion", "className": "text-nowrap", "searchable": true, "sortable": true },
                        {
                            "data": "fecha", "name": "fecha", "className": "text-nowrap", "render": (data, type, row, meta) => 
                            {
                                return `
                                <input id="fecha_${row.prelacion}" type="text" value="${row.fecha}"
                                class="datepicker-input form-control" placeholder="DD/MM/AAAA"
                                data-position="bottom center" autocomplete="off" readonly="readonly" 
                                style="width: 7.1em" />
                                `;
                            }
                        },
                        {
                            "data": "estado", "name": "estado", "className": "text-nowrap", "render": (data, type, row, meta) => 
                            {
                                return `
                                <select id="estado_${row.prelacion}" class="chosen-select" searchable="Buscar">
                                    <option value="" selected>Seleccione</option>   
                                </select>
                                `;
                            }
                        },
                        {
                            "data": "ncorr", "name": "ncorr", "className": "text-nowrap", "sortable": false, "render": (data, type, row, meta) => 
                            {
                                return `
                                <button onclick="eliminarRegistro(${row.prelacion})">Eliminar</button>
                                `;
                            }
                        }
                    ]
                })
                .on("page.dt", () => { 
                    console.log("Cambio de página");
                    setTimeout(() => definirInputsGrilla(), 200);
                } )

                //.on("draw", () => { resolve(true); });

                //setTimeout(() => resolve(true), 800);
            });
        }

        async function eliminarRegistro(prelacion)
        {
            datos = datos.filter(x => x.prelacion != prelacion);
            await construirGrillaPerfilesOcupacionalesCualificacion(datos);
            definirInputsGrilla();
        }

        function obtenerDatos() 
        {
            return [
                { ncorr: 101, prelacion: 1, nombre: "Probando 1", descripcion: "Probando descripción 1", fecha: "07-11-2022", estado: "Activo" },
                { ncorr: 102, prelacion: 2, nombre: "Probando 2", descripcion: "Probando descripción 2", fecha: "07-11-2022", estado: "Inactivo" },
                { ncorr: 103, prelacion: 3, nombre: "Probando 3", descripcion: "Probando descripción 3", fecha: "07-11-2022", estado: "Inactivo" },
                { ncorr: 104, prelacion: 4, nombre: "Probando 4", descripcion: "Probando descripción 4", fecha: "07-11-2022", estado: "Activo" },
                { ncorr: 105, prelacion: 5, nombre: "Probando 5", descripcion: "Probando descripción 5", fecha: "07-11-2022", estado: "Activo" },
                { ncorr: 106, prelacion: 6, nombre: "Probando 6", descripcion: "Probando descripción 6", fecha: "07-11-2022", estado: "Activo" },
                { ncorr: 107, prelacion: 7, nombre: "Probando 7", descripcion: "Probando descripción 7", fecha: "07-11-2022", estado: "Activo" },
                { ncorr: 108, prelacion: 8, nombre: "Probando 8", descripcion: "Probando descripción 8", fecha: "07-11-2022", estado: "Activo" },
                { ncorr: 109, prelacion: 9, nombre: "Probando 9", descripcion: "Probando descripción 9", fecha: "07-11-2022", estado: "Activo" },
                { ncorr: 110, prelacion: 10, nombre: "Probando 10", descripcion: "Probando descripción 10", fecha: "07-11-2022", estado: "Activo" },
                { ncorr: 111, prelacion: 11, nombre: "Probando 11", descripcion: "Probando descripción 11", fecha: "07-11-2022", estado: "Activo" },
                { ncorr: 112, prelacion: 12, nombre: "Probando 12", descripcion: "Probando descripción 12", fecha: "07-11-2022", estado: "Activo" },
                { ncorr: 113, prelacion: 13, nombre: "Probando 13", descripcion: "Probando descripción 13", fecha: "07-11-2022", estado: "Activo" },
                { ncorr: 114, prelacion: 14, nombre: "Probando 14", descripcion: "Probando descripción 14", fecha: "07-11-2022", estado: "Activo" }
            ];
        }

        function quitarSeleccionSelect(querySelector) 
        {
            $(querySelector).find('option:first-child').prop('selected', true).end().trigger('chosen:updated');
        }

        function limpiarSelect(querySelector) 
        {
            $(querySelector + ' option[value!=""]').remove().end();    // Remueve todos los options excepto el seleccione
            $(querySelector).trigger("chosen:updated");
        }

        function llenarSelect(datos) 
        {
            if (Array.from($(datos.querySelector + ' option[value!=""]')).length)   // Si tiene elementos excepto el seleccione
                limpiarSelect(datos.querySelector);                              // Esto sirve al refrescar el combobox con nuevos datos

            quitarSeleccionSelect(datos.querySelector);

            if (datos.data != null) 
            {
                if (datos.selectedValue == null) 
                {
                    datos.data.forEach(c => {
                        $(datos.querySelector).append('<option value="' + c.codigo + '">' + c.descripcion + '</option>');
                    });
                }
                else 
                {
                    if (Array.isArray(datos.selectedValue)) {
                        var arreglo = datos.selectedValue;

                        datos.data.forEach(c => {
                            let selected = (arreglo.includes(c.codigo.toString())) ? "selected" : "";
                            $(datos.querySelector).append('<option value="' + c.codigo + '" ' + selected + '>' + c.descripcion + '</option>');

                        });
                    }
                    else {
                        datos.data.forEach(c => {
                            let selected = (c.codigo == datos.selectedValue) ? "selected" : "";
                            $(datos.querySelector).append('<option value="' + c.codigo + '" ' + selected + '>' + c.descripcion + '</option>');
                        });
                    }
                }

            }

            $(datos.querySelector).on("change", () => {
                if (datos.onchange != null && typeof datos.onchange === "function") datos.onchange();
            });

            $(datos.querySelector).trigger("chosen:updated");   // El select toma los cambios realizados

            if (datos.multiple != null && datos.multiple)   // Si es un select multiple, lo refresca
            {
                $(datos.querySelector).materialSelect("destroy");
                $(datos.querySelector).removeAttr("disabled");
            }
        }

        function showLoading() {
            $('#loadingOverlay').show();
        }

        function hideLoading() {
            $('#loadingOverlay').hide();
        }

        /*
        DECLARE
            arreglo_recibido   json_array_t := json_array_t ( 
                '[
                    { "ncorr": null, "prelacion": 1, "nombre": "Probando 1", "descripcion": "Probando descripción 1", "fecha": "07-11-2022", "estado": "Activo" },
                    { "ncorr": 102, "prelacion": 2, "nombre": "Probando 2", "descripcion": "Probando descripción 2", "fecha": "07-11-2022", "estado": "Activo" }
                ]'
        );
        objeto   json_object_t;
        ncorr varchar(40); 
        prelación varchar(40);
        nombre varchar(40);
        descripcion varchar(40);
        fecha varchar(40);
        estado varchar(40);
        BEGIN
            DBMS_OUTPUT.put_line ('El número de elementos del arreglo es: ' || arreglo_recibido.get_size); 
            DBMS_OUTPUT.put_line('===============================>>>>>'); 

            FOR index_ele IN 0 .. arreglo_recibido.get_size - 1 LOOP 
            
                objeto := json_object_t (arreglo_recibido.get(index_ele));
                
                ncorr := replace(objeto.get('ncorr').to_string,'"','');
                prelación := replace(objeto.get('prelacion').to_string,'"','');
                nombre := replace(objeto.get('nombre').to_string,'"','');
                fecha := replace(objeto.get('fecha').to_string,'"','');
                estado := replace(objeto.get('estado').to_string,'"','');
                
                DBMS_OUTPUT.put_line('ncorr: ' || ncorr);
                DBMS_OUTPUT.put_line('prelación es: ' || prelación);
                DBMS_OUTPUT.put_line('nombre: ' || nombre);
                DBMS_OUTPUT.put_line('fecha: ' || fecha);
                DBMS_OUTPUT.put_line('estado: ' || estado);
                DBMS_OUTPUT.put_line('===============================>>>>>'); 
            END LOOP; 
        END;
        */

        //=====================================================================================>>>>>
        // Ejemplo funcionando:

        // var cadena = JSON.stringify(datos).split("\"").join("''");

/*
SET SERVEROUTPUT ON

DECLARE
    --cadena varchar(5000) := '[{ "ncorr": null, "prelacion": 1, "nombre": "Probando 1", "descripcion": "Probando descripción 1", "fecha": "07-11-2022", "estado": "Activo" },{ "ncorr": 102, "prelacion": 2, "nombre": "Probando 2", "descripcion": "Probando descripción 2", "fecha": "07-11-2022", "estado": "Activo" }]';

    cadena varchar(5000) := '[{''ncorr'':null,''prelacion'':15,''nombre'':''Probando 15'',''descripcion'':''Probando descripción 15'',''fecha'':''30-12-2022'',''estado'':''Activo''},{''ncorr'':114,''prelacion'':14,''nombre'':''Probando 14'',''descripcion'':''Probando descripción 14'',''fecha'':''07-11-2022'',''estado'':''Activo''},{''ncorr'':113,''prelacion'':13,''nombre'':''Probando 13'',''descripcion'':''Probando descripción 13'',''fecha'':''07-11-2022'',''estado'':''Activo''},{''ncorr'':112,''prelacion'':12,''nombre'':''Probando 12'',''descripcion'':''Probando descripción 12'',''fecha'':''07-11-2022'',''estado'':''Activo''},{''ncorr'':111,''prelacion'':11,''nombre'':''Probando 11'',''descripcion'':''Probando descripción 11'',''fecha'':''07-11-2022'',''estado'':''Activo''},{''ncorr'':110,''prelacion'':10,''nombre'':''Probando 10'',''descripcion'':''Probando descripción 10'',''fecha'':''07-11-2022'',''estado'':''Activo''},{''ncorr'':109,''prelacion'':9,''nombre'':''Probando 9'',''descripcion'':''Probando descripción 9'',''fecha'':''07-11-2022'',''estado'':''Activo''},{''ncorr'':108,''prelacion'':8,''nombre'':''Probando 8'',''descripcion'':''Probando descripción 8'',''fecha'':''07-11-2022'',''estado'':''Activo''},{''ncorr'':107,''prelacion'':7,''nombre'':''Probando 7'',''descripcion'':''Probando descripción 7'',''fecha'':''07-11-2022'',''estado'':''Activo''},{''ncorr'':106,''prelacion'':6,''nombre'':''Probando 6'',''descripcion'':''Probando descripción 6'',''fecha'':''07-11-2022'',''estado'':''Activo''},{''ncorr'':105,''prelacion'':5,''nombre'':''Probando 5'',''descripcion'':''Probando descripción 5'',''fecha'':''07-11-2022'',''estado'':''Activo''},{''ncorr'':104,''prelacion'':4,''nombre'':''Probando 4'',''descripcion'':''Probando descripción 4'',''fecha'':''07-11-2022'',''estado'':''Activo''},{''ncorr'':103,''prelacion'':3,''nombre'':''Probando 3'',''descripcion'':''Probando descripción 3'',''fecha'':''07-11-2022'',''estado'':''Inactivo''},{''ncorr'':102,''prelacion'':2,''nombre'':''Probando 2'',''descripcion'':''Probando descripción 2'',''fecha'':''07-11-2022'',''estado'':''Inactivo''},{''ncorr'':101,''prelacion'':1,''nombre'':''Probando 1'',''descripcion'':''Probando descripción 1'',''fecha'':''07-11-2022'',''estado'':''Activo''}]';
    nueva_cadena varchar(5000);
    arreglo   json_array_t;
    objeto   json_object_t;
    ncorr int; 
    prelación varchar(40);
    nombre varchar(40);
    descripcion varchar(40);
    fecha DATE;
    estado varchar(40);
    valor varchar(40);

    function obtenerValor(p_obj IN JSON_OBJECT_T, nombre varchar2) return varchar2 is 
        cadena varchar(80);
    begin 
       IF p_obj.has(nombre) AND p_obj.get(nombre) is not null THEN
            cadena := replace(p_obj.get(nombre).to_string, '"', '');
            return CASE 
                WHEN cadena <> 'null' THEN replace(p_obj.get(nombre).to_string, '"', '') 
                ELSE null 
            END;
       END IF;
       raise_application_error( -20001, 'No existe la key ' || nombre);
       return null; 
    end;
BEGIN
    
    nueva_cadena := replace(cadena,'''','"');   -- Reemplaza el  ''   por   "
    -- DBMS_OUTPUT.put_line(nueva_cadena);
    
    arreglo := json_array_t (nueva_cadena);
    DBMS_OUTPUT.put_line ('El número de elementos del arreglo es: ' || arreglo.get_size); 
    DBMS_OUTPUT.put_line('===============================>>>>>'); 

    FOR index_ele IN 0 .. arreglo.get_size - 1 LOOP 
    
        objeto := json_object_t (arreglo.get(index_ele));
        ncorr := TO_NUMBER(COALESCE(obtenerValor(objeto, 'ncorr'), '0'));
        prelación := obtenerValor(objeto, 'prelacion');
        nombre := obtenerValor(objeto, 'nombre');
        estado := obtenerValor(objeto, 'estado');
        
        valor := obtenerValor(objeto, 'fecha');
        fecha := CASE 
            WHEN valor is not null THEN TO_DATE(trim(valor), 'dd-mm-yyyy') 
            ELSE null 
        END;
        
        IF ncorr = 0 THEN  
            DBMS_OUTPUT.put_line('INSERT INTO EJEMPLO(ncorr, prelación, nombre, fecha, estado) 
            VALUES (EJEMPLO.NEXTVAL, ' || prelación || ', ' || nombre || ', ' || TO_CHAR(fecha, 'dd-mm-yyyy') || ', ' || estado || ');');
        ELSE  
            DBMS_OUTPUT.put_line('UPDATE EJEMPLO 
            SET prelacion = ' || prelación || ', nombre = ' || nombre || ', fecha = ' || TO_CHAR(fecha, 'dd-mm-yyyy') || ', estado = ' || estado || ' 
            WHERE ncorr = ' || ncorr);
        END IF;
        
        DBMS_OUTPUT.put_line('===============================>>>>>'); 
    END LOOP; 
    
    --raise_application_error( -20001, 'Probando error');
    DBMS_OUTPUT.put_line('COMMIT;'); 
    
EXCEPTION WHEN OTHERS THEN
    dbms_output.put_line( sqlerrm );
    DBMS_OUTPUT.PUT_LINE('ROLLBACK');
END;

*/

    </script>

</body>
</html>