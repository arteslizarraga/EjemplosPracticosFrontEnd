<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Sistema de definici&oacute;n de Programas Formativos: M&oacute;dulos de Poblamiento del MCTP</title>
    <link rel="shortcut icon" href="https://www.inacap.cl/web/template-aplicaciones/img/favicon.ico" />
    <link rel="stylesheet" href="https://www.inacap.cl/web/template-aplicaciones/css/mdb.min.css">
    <style>

        .btn-add{
          border: none;
          color: #666;
          cursor: pointer;
          border-bottom: 1px solid #666;
          background-color: transparent;
        }

        .tooltip .tooltip-inner{
            max-width: 1000px !important;
            text-align: left !important;
        }
    </style>
</head>
<body id="appBody" class="d-flex flex-column">

    <div class="page-content">

        <div class="navbar-overlay"></div>

        <div id="menuContent">
            
            <!-- Loading Overlay -->
            <div class="loading-backdrop" id="loadingOverlay">
                <div class="loading-circle">
                    <div class="preloader-wrapper big active"><div class="spinner-layer spinner-white-only"><div class="circle-clipper left"><div class="circle"></div></div><div class="gap-patch"><div class="circle"></div></div><div class="circle-clipper right"><div class="circle"></div></div></div></div>
                </div>
            </div>
            <header class="header">

                <div class="header-container">

                    <!--Logo-->
                    <div class="header-logo">
                        <a href="https://www.inacap.cl">
                            <img src="https://www.inacap.cl/web/template-aplicaciones/img/isotipo.png" alt="INACAP" class="logo-mobile">
                            <img src="https://www.inacap.cl/web/template-aplicaciones/img/logo-inacap.png" alt="INACAP" class="logo">
                        </a>
                    </div>

                    <!--Titulo, recuerda que tambien debes reemplazar el nombre en el script m&aacute;s abajo-->
                    <div class="header-title">
                        <h1 id="title">
                            <a href="#">Título</a>
                        </h1>
                    </div>

                    <!--Datos del Usuario-->
                    <div class="user-info">

                        <div class="user-name mr-4">
                            <p> Ejemplo Nombre </p>
                        </div>

                        <!-- Iconos encabezado - Mobile -->
                        <div class="user-mobile-menu user-button dropdown dropdown-toggle" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <i class="material-icons">more_vert</i>

                            <div class="dropdown-menu dropdown-menu-right">
                                <p class="dropdown-user-name">Colaborador X</p>
                                <p class="dropdown-title dropdown-title--border">Accesibilidad</p>
                                <ul class="accesibility-menu">
                                    <li class="accesibility-menu__item">
                                        <div class="d-flex align-items-center justify-content-between" onclick="darkMode();">
                                            <span class="tipo-de-modo">Modo Oscuro</span>
                                            <div class="d-flex justify-content-center">
                                                <span>
                                                    <i class="material-icons">brightness_medium</i>
                                                </span>
                                            </div>
                                        </div>
                                    </li>
                                    <li class="accesibility-menu__item">
                                        <div class="d-flex align-items-center justify-content-between">
                                            <span>Tama&ntilde;o de letra</span>
                                            <div class="d-flex justify-content-center">
                                                <span tabindex="0" role="button" class="btnDecrease btn btn-round btn-fonts btn-secondary d-flex align-items-center justify-content-center waves-effect waves-light">
                                                    <i class="material-icons">remove</i>
                                                </span>
                                                <span tabindex="0" role="button" class="btnEnlarge btn btn-round btn-fonts btn-default d-flex align-items-center justify-content-center ml-2 mr-0 waves-effect waves-light">
                                                    <i class="material-icons">add</i>
                                                </span>
                                            </div>
                                        </div>
                                    </li>
                                </ul>

                                <!--- Cerrar Sesi&oacute;n-->
                                <p class="dropdown-title dropdown-title--border">Cuenta</p>
                                <ul class="accesibility-menu">
                                    <li class="accesibility-menu__item">
                                        <div class="d-flex align-items-center justify-content-between">
                                            <span id="tipo-de-modo">Cerrar Sesi&oacute;n</span>
                                            <div class="d-flex justify-content-center">
                                                <span>
                                                    <i class="material-icons">exit_to_app</i>
                                                </span>
                                            </div>
                                        </div>
                                    </li>
                                </ul>

                            </div>

                        </div>
                        <!-- Iconos encabezado - Mobile -->

                        <!-- Iconos encabezado - Escritorio-->
                        <div class="user-desktop-icons">

                            <div class="user-accesibility user-button dropdown dropdown-toggle" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">

                                <i class="material-icons ">accessibility</i>

                                <div class="dropdown-menu dropdown-menu-right">
                                    <p class="dropdown-title">Accesibilidad</p>
                                    <ul class="accesibility-menu">
                                        <li class="accesibility-menu__item">
                                            <div class="d-flex align-items-center justify-content-between" onclick="darkMode();">
                                                <span class="tipo-de-modo">Modo Oscuro</span>
                                                <div class="d-flex justify-content-center">
                                                    <span>
                                                        <i class="material-icons">brightness_medium</i>
                                                    </span>
                                                </div>
                                            </div>
                                        </li>
                                        <li class="accesibility-menu__item">
                                            <div class="d-flex align-items-center justify-content-between">
                                                <span>Tama&ntilde;o de letra</span>
                                                <div class="d-flex justify-content-center">
                                                    <span tabindex="0" role="button" class="btnDecrease btn btn-round btn-fonts btn-secondary d-flex align-items-center justify-content-center waves-effect waves-light"><i class="material-icons">remove</i></span>
                                                    <span tabindex="0" role="button" class="btnEnlarge btn btn-round btn-fonts btn-default d-flex align-items-center justify-content-center ml-2 mr-0 waves-effect waves-light"><i class="material-icons">add</i></span>
                                                </div>
                                            </div>
                                        </li>
                                    </ul>
                                </div>

                            </div>

                            <div class="user-logout user-button">
                                <a href="#"><i class="material-icons">exit_to_app</i></a>
                            </div>

                        </div>
                        <!-- Iconos encabezado - Escritorio-->

                    </div>
                </div>

            </header>
        </div>
        <main class="container">
            <section>

                <div class="card">

                    <div class="card-header">
                        <div class="row">
                            <div class="col-12 d-flex align-items-end justify-content-between">
                                <h4 class="float-left heading h4-responsive mb-0">Ejemplo Grilla</h4>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row mb-4">

                            <div class="col-12">
                                <br/>

                                <table id="TablaPrincipal" class="datatables table table-hover table-striped table-bordered m-0" width="100%">
                                    <thead>
                                      <tr>
                                        <th data-orderable="false">Posición</th>
                                        <th>Correlativo</th>
                                        <th>Prelación</th>
                                        <th>Nombre</th>
                                        <th>Descripción</th>
                                        <th>Fecha</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                      </tr>
                                    </thead>
                                    <tbody>
                  
                                    </tbody>
                                </table> 
                            </div>

                        </div>
                        <div class="row mb-4">
                            <div class="col col-md-6 d-flex justify-content-start">
                                <button type="button" onclick="agregarRegistro()" class="btn-add p-2">
                                    + Agregar Nueva Fila a la Tabla
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="row py-2 flex-row">
                      
                          <div class="col col-md-6  d-flex justify-content-start">

                            <button type="button" class="btn btn-outline waves-effect waves-light">
                                <span>Cualquiercosa</span>
                            </button>
                          </div>
                          <div class="col col-md-6 d-flex justify-content-end">
        
                            <button type="button" onclick="limpiarDatos(); construirGrilla()" class="btn btn-outline waves-effect waves-light">
                                <span>Limpiar Datos</span>
                            </button>

                            <button type="button" onclick="mostrarJson()" class="btn btn-default waves-effect waves-light">
                              <span>Mostrar json</span>
                            </button>
                        
                          </div>
                        </div>
                    </div>

                </div>

            </section>
        </main>
    </div>

    <!-- ========================================================= -->

    <div class="modal fade" id="ModalEditar" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
          <div class="modal-content">

              <div class="modal-header">
                  <p class="heading lead">Modificar Informaci&oacute;n</p>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                      <span aria-hidden="true">&times;</span>
                  </button>
              </div>
              <div class="modal-body px-0">

                  <div class="row mb-4">

                    <div class="col-12 col-md-6">
                        <div class="md-form">
                            <p name="posicion" class="form-control" style="border: none"></p>
                            <label class="active">Posición</label>
                        </div>
                    </div> 
                    <div class="col-12 col-md-6">
                        <div class="md-form">
                            <p name="fecha" class="form-control" style="border: none"></p>
                            <label class="active">Fecha</label>
                        </div>
                    </div> 

                    <div class="col-12 col-md-6">
                        <div class="md-form">
                            <select name="prelacion" class="chosen-select">
                                <option value="" selected>Seleccione</option>
                            </select>
                            <label class="active">Prelación</label>
                        </div>
                    </div>

                    <div class="col-12 col-md-6">
                        <div class="md-form mb-3">
                            <input type="text" name="nombre" class="form-control mb-0" placeholder="Ingrese nombre">
                            <label class="active">Nombre</label>
                        </div>
                    </div>

                  </div>
                  <div class="row mb-4">

                      <div class="col-12 col-md-12">
                          <div class="md-form mb-3">
                              <textarea name="descripcion" rows="4" placeholder="Ingrese descripción" class="form-control md-textarea"></textarea>
                              <label class="active">Descripción</label>
                          </div>
                      </div>

                  </div>

              </div>
              <div class="modal-footer px-0 justify-content-between">

                  <button type="button" class="btn mx-2 btn-outline waves-effect waves-light" data-dismiss="modal">Cerrar</button>
                  <div>
                      <button type="button" name="btn-guardar" onclick="guardarDatosModalEditar()" 
                      class="btn mx-2 btn-default waves-effect waves-light">Guardar</button>

                      <button type="button" name="btn-guardar-y-continuar" onclick="guardarDatosModalEditar(true)" 
                      class="btn mx-2 btn-default waves-effect waves-light">Guardar y Continuar</button>
                  </div>
              </div>

          </div>
      </div>
    </div>

    <!-- ========================================================= -->
    <!-- 9-5-2023 -->

    <div class="modal fade" id="ModalVerJson" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
          <div class="modal-content">

              <div class="modal-header">
                  <p class="heading lead">Ver json</p>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                      <span aria-hidden="true">&times;</span>
                  </button>
              </div>
              <div class="modal-body px-0">

                  <div class="row mb-4">

                      <div class="col-12 col-md-6">
                          <div class="md-form mb-3">
                              <textarea name="jsonSinEditar" rows="15" placeholder="Ingrese Json" class="form-control md-textarea"></textarea>
                              <label class="active">Json sin editar</label>
                          </div>
                      </div>
                      <div class="col-12 col-md-6">
                        <div class="md-form mb-3">
                            <textarea name="jsonParaEnviar" rows="15" placeholder="Ingrese Json" class="form-control md-textarea"></textarea>
                            <label class="active">Json para enviar</label>
                        </div>
                    </div>

                  </div>

              </div>
              <div class="modal-footer px-0 justify-content-between">
                  <button type="button" class="btn mx-2 btn-outline waves-effect waves-light" data-dismiss="modal">Cerrar</button>
              </div>

          </div>
      </div>
    </div>

    <div class="modal fade" id="ModalFiltrarTablaPrincipal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-notify" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <p class="heading lead">Filtros</p>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">

                    <div class="row mb-4">

                        <div class="col-12 col-md-6">
                            <div class="md-form">
                                <select name="estado" class="chosen-select">
                                    <option value="" selected>Seleccione</option>
                                    <option value="Activo">Activo</option>
                                    <option value="Inactivo">Inactivo</option>
                                </select>
                                <label class="active">Estado</label>
                            </div>
                        </div>
                    </div>

                </div>
                <div class="modal-footer justify-content-between">
                    <button onclick="limpiarFormulario('#ModalFiltrarTablaPrincipal')" type="button" class="btn btn-link px-0 d-flex align-items-center waves-effect waves-light">
                        <span class="material-icons mr-1">close
                        </span>
                        Limpiar Filtros
                    </button>
                    <div class="d-flex flex-wrap">
                        <button class="btn mx-2 btn-secondary waves-effect waves-light" data-dismiss="modal">Cerrar</button>

                        <button onclick="limpiarDatos(); construirGrilla()"
                        class="btn mx-2 btn-default waves-effect waves-light alerta" data-dismiss="modal">Filtrar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================================= -->

    <footer class="page-footer">
        <div class="container py-3">
            <div class="d-flex align-items-center justify-content-center justify-content-md-start">
                <div class="logo-gst">
                    <img src="http://www.inacap.cl/web/template-aplicaciones/img/logo-gst.png" alt="">
                </div>
                <span class="pl-2 pl-md-4">Gerencia de Sistemas y Tecnolog&iacute;as</span>
            </div>
        </div>
    </footer>


    <!-- SCRIPTS -->
    <script src="https://www.inacap.cl/web/template-aplicaciones/js/jquery-3.3.1.min.js"></script>
    <!-- Bootstrap tooltips -->
    <script src="https://www.inacap.cl/web/template-aplicaciones/js/popper.min.js"></script>
    <!-- Bootstrap core JavaScript -->
    <script src="https://www.inacap.cl/web/template-aplicaciones/js/bootstrap.min.js"></script>
    <!-- MDB core JavaScript -->
    <script src="https://www.inacap.cl/web/template-aplicaciones/js/mdb.min.js"></script>

    <script src="http://www.inacap.cl/web/template-aplicaciones/js/chosen.jquery.js"></script>

    <script src="https://www.inacap.cl/web/template-aplicaciones/js/datepicker.js"></script>
    
    <script src="http://www.inacap.cl/web/template-aplicaciones/js/datatables.min.js"></script>

    <script>

        this.listaObjetos = obtenerDatos(); 
        this.listaObjetosFiltrada = [];
        this.indexDetalle = 0;

        this.nextIndex = 0;
        this.nextIndexFiltrado = 0;

        this.registrosPorPagina = 5;
        this.paginaActual = 0;

        $(document).ready(function ()
        {
            // Activar selects
            $(".chosen-select").chosen({ disable_search_threshold: 10, no_results_text: "Sin Resultados para: ", width: "100%" });
            $(".mdb-select").material_select();

            construirGrilla();
        });

        function agregarRegistro()
        {
            let prelacion = (this.listaObjetos.length > 0) ? (Math.max(...this.listaObjetos.map(o => o.prelacion)) + 1) : 1;
            let fechaHoy = new Date().toJSON().slice(0,10).split("-").reverse().join("-");  // "28-12-2022"
            this.listaObjetos.push({ ncorr: null, prelacion, nombre: `Probando ${prelacion}`, descripcion: `Probando descripción ${prelacion}`, fecha: fechaHoy, estado: "Activo" });

            construirGrilla();
        }

        function limpiarDatos()
        {
            this.listaObjetos = obtenerDatos(); 
            this.indexDetalle = 0;
            this.nextIndex = 0;
            this.registrosPorPagina = 5;
            this.paginaActual = 0;
        }

        function definirInputsGrilla()
        {
            Array.from($("#TablaPrincipal").DataTable().rows({ filter: "applied", page: "current" }).data()).forEach(x => 
            {
                let registro = this.listaObjetos.find(y => y.prelacion == x.prelacion);
                let txtFecha = $(`#fecha_${x.prelacion}`);

                if(txtFecha.data("datepicker") == null)  // Si no ha sido inicializado
                {
                    txtFecha.datepicker({ 
                        language: "es", 
                        dateFormat: "dd-mm-yyyy",
                        autoClose: true,
                        onSelect: (e) => {
                            registro.fecha = e;
                            // console.log(registro);
                        } 
                    });
                }

                llenarSelect({ 
                    selectedValue: x.estado,
                    querySelector: `#estado_${x.prelacion}`, 
                    data: [{codigo: "Activo", descripcion: "Activo"}, {codigo: "Inactivo", descripcion: "Inactivo"}],
                    onchange: () => {
                        registro.estado = $(`#estado_${x.prelacion}`).val();
                        // console.log(registro);
                    }
                });

                $(`#estado_${x.prelacion}`).chosen({ disable_search_threshold: 10, no_results_text: "Sin Resultados para: ", width: "100%" });
            });
        }

        function construirGrilla()
        {
            showLoading();

            let limitarTextoCelda = (descripcion, size = 40) =>
            {
                if (descripcion != null && typeof descripcion === "string")
                {
                    if (descripcion.includes("\\n")) descripcion = descripcion.split("\\n").join("\n");   // Reemplaza saltos de línea con doble backslash por uno normal

                    if (descripcion.length > size)
                    {
                        let titulo = descripcion;   // El título sí puede contener <br>
                        if (titulo.includes("\"")) titulo = titulo.replaceAll("\"", "&quot;");  // Reemplaza comillas dobles por &quot;
                        if (titulo.includes("\n")) titulo = titulo.split("\n").join("<br/>");

                        return `<container data-html="true" data-toggle="tooltip" data-placement="top" title="${titulo}" style="cursor: pointer">${descripcion.slice(0, size)} ...</container>`;
                    }
                }

                return descripcion
            };

            //================>>>>

            this.listaObjetosFiltrada = this.listaObjetos.map((x, index) => {
                x.indexReal = index;    // Le agrega el index real, para que al filtrar, este index no se pierda    
                return x;
            });

            let modalFiltrar = $("#ModalFiltrarTablaPrincipal");

            let filtro = {
                estado: modalFiltrar.find("[name='estado']").val()
            };

            if (validarNuloVacio(filtro.estado))
                this.listaObjetosFiltrada = this.listaObjetosFiltrada.filter(x => x.estado == filtro.estado);

            // this.listaObjetosFiltrada.sort((a, b) => b.prelacion - a.prelacion);   // Ordena por prelacion desc    (AL HACER ESTO, EL BOTÓN GUARDA Y CONTINUAR CAMBIA SU FUNCIONAMIENTO POR EL this.nextIndex)

            //================>>>>

            //this.listaObjetos.sort((a, b) => b.prelacion - a.prelacion);   // Ordena por prelacion desc

            $("#TablaPrincipal").DataTable({
                data: this.listaObjetosFiltrada,
                destroy: true,
                pageLength: this.registrosPorPagina,
                dom: '<"top top-grey"<"dataTables_actions"f>> <t> <"bottom mt-2 d-flex align-items-center justify-content-between flex-wrap"<"d-flex" il>p>',
                //scrollY: "60vh",
                //"scrollX": true,  // Si la tabla tiene poco tamaño hacia el lado, esto hace que se vea pequeña
                //lengthMenu: [[10, 20, 30], [10, 20, 30]],
                bLengthChange: false, // Oculta el select de registros por página
                columnDefs: [
                    //{ "width": "260px", "targets": 4 }  // Ancho de la columna acciones
                ],
                aaSorting: [],
                processing: true,
                //serverSide: true, 
                filter: true,
                orderMulti: false,
                responsive: true,
                fnDrawCallback: () => 
                {
                    hideLoading();

                    setTimeout(() => {
                        definirInputsGrilla();
                        $('[data-toggle="tooltip"]').tooltip();  // Activar tooltips
                    }, 200);   
                },
                columns: [
                    { "className": "text-nowrap", "render": (data, type, row, meta) => row.indexReal },
                    { data: "ncorr", "className": "text-nowrap", "searchable": true, "sortable": true, "render": (data, type, row, meta) => row.ncorr ?? "No tiene" },
                    { data: "prelacion", "className": "text-nowrap", "searchable": true, "sortable": true },
                    { "className": "text-nowrap", "render": (data, type, row, meta) => limitarTextoCelda(row.nombre) },
                    { "className": "text-nowrap", "render": (data, type, row, meta) => limitarTextoCelda(row.descripcion) },
                    {
                        "data": "fecha", "name": "fecha", "className": "text-nowrap", "render": (data, type, row, meta) => 
                        {
                            return `
                            <input id="fecha_${row.prelacion}" type="text" value="${row.fecha}"
                            class="datepicker-input form-control" placeholder="DD/MM/AAAA"
                            data-position="bottom center" autocomplete="off" readonly="readonly" 
                            style="width: 7.1em" />
                            `;
                        }
                    },
                    {
                        "data": "estado", "name": "estado", "className": "text-nowrap", "render": (data, type, row, meta) => 
                        {
                            return `
                            <select id="estado_${row.prelacion}" class="chosen-select" searchable="Buscar">
                                <option value="" selected>Seleccione</option>   
                            </select>
                            `;
                        }
                    },
                    {
                        "data": "ncorr", "name": "ncorr", "className": "text-nowrap", "sortable": false, "render": (data, type, row, meta) => 
                        {
                            return `
                            <button onclick="abrirModalEditar(${row.indexReal})">Editar</button>
                            <button onclick="eliminarRegistro(${row.indexReal})">Eliminar</button>
                            `;
                        }
                    }
                ]
            })
            .on("page.dt", () =>   // Al cambiar de página
            {  
                this.paginaActual = $("#TablaPrincipal").DataTable().page.info().page;
                setTimeout(() => definirInputsGrilla(), 200);
            })
            .page(this.paginaActual).draw(false);     

            $("#TablaPrincipal_wrapper .top").append(`
                <div class="dataTables_custom-buttons">
                <button type="button" class="btn btn-rounded btn-default waves-effect" data-toggle="modal" data-target="#ModalFiltrarTablaPrincipal">
                    <span class="d-flex align-items-center">
                        <span class="material-icons mr-2">filter_list</span>
                        <span>Filtros</span>
                    </span>
                </button>
                </div>
            `);

        }

        function abrirModalEditar(index)
        {
            let elemento = this.listaObjetos[index];
            this.indexDetalle = index;                  // Almacena el index para así poder actualizar

            llenarSelect({ 
                selectedValue: elemento.prelacion,
                querySelector: "#ModalEditar [name='prelacion']", 
                data: this.listaObjetos.map((x, index) => {
                    let numero = index + 1;
                    return { codigo: numero, descripcion: numero };
                })
            });

            let modal = $("#ModalEditar");

            // Coloca textos para orientar al usuario
            modal.find("[name='posicion']").html(index);
            modal.find("[name='fecha']").html(elemento.fecha);

            modal.find("[name='nombre']").val(elemento.nombre); 
            modal.find("[name='descripcion']").val(elemento.descripcion); 

            modal.modal("show"); 

            //=================>>>>>
            // Botón Guardar y continuar

            let siguienteElementoFiltrado = this.listaObjetosFiltrada.find(x => x.indexReal > index);
            this.nextIndexFiltrado = this.listaObjetosFiltrada.findIndex(x => x.indexReal > index);
            this.nextIndex = (siguienteElementoFiltrado != null) ? siguienteElementoFiltrado.indexReal : 0;

            let btnGuardarContinuar = modal.find("[name='btn-guardar-y-continuar']");
            btnGuardarContinuar.attr("disabled", true).attr("class", "btn");  // Deshabilita botón guardar y continuar

            if (this.nextIndex != 0)
                btnGuardarContinuar.removeAttr("disabled").attr("class", "btn btn-default waves-effect waves-light");
            else
                toastr.success("Último registro");
        
            //=================>>>>>
        }

        function guardarDatosModalEditar(pasarSiguientePagina = false)
        {
            let modal = $("#ModalEditar");
            let prelacion = modal.find("[name='prelacion']").val();
            let nombre = modal.find("[name='nombre']").val();
            let descripcion = modal.find("[name='descripcion']").val();

            //============>>>>

            let errores = [];

            if (!validarNuloVacio(prelacion))
                errores.push("La prelación es requerida");

            if (!validarNuloVacio(nombre))
                errores.push("El nombre es requerido");    

            if (!validarNuloVacio(descripcion))
                errores.push("La descripción es requerida");

            if (errores.length > 0) {
                errores.reverse().forEach(error => toastr.error(error));
                return;
            }

            //============>>>>

            let elemento = this.listaObjetos[this.indexDetalle];
            elemento.prelacion = prelacion;
            elemento.nombre = nombre;
            elemento.descripcion = descripcion;

            modal.modal("hide"); 

            //=====================>>>

            if (pasarSiguientePagina)
            {
                // this.paginaActual = (Math.ceil((this.nextIndex + 1) / this.registrosPorPagina)) - 1;    // Original

                this.paginaActual = (Math.ceil((this.nextIndexFiltrado + 1) / this.registrosPorPagina)) - 1;

                setTimeout(() => {
                    abrirModalEditar(this.nextIndex);
                    construirGrilla();
                }, 500);
            }
            else {
                construirGrilla();
            }
        }

        function eliminarRegistro(index)
        {
            this.listaObjetos.splice(index, 1);     // Elimina la posición del arreglo

            this.listaObjetos.sort((a, b) => a.prelacion - b.prelacion).forEach((x, index) => x.prelacion = index + 1);  // Re asigna prelacion a todos los elementos del arreglo
            
            construirGrilla();
        }

        function mostrarJson()
        {
            let cadenaJsonSinEditar = JSON.stringify(this.listaObjetos);

            let modal = $("#ModalVerJson");
            modal.find("[name='jsonSinEditar']").val(cadenaJsonSinEditar);
            
            let copiaDetallesParaEnviar = this.listaObjetos.map(x => {
                return {
                    tu_tabla_prelacion: x.prelacion,
                    tu_tabla_nombre: x.nombre,
                    tu_tabla_descripcion: x.descripcion,
                    tu_tabla_fecha: x.fecha,
                    tu_tabla_estado: x.estado
                }
            });

            let p_json_datos = JSON.stringify(copiaDetallesParaEnviar);
            modal.find("[name='jsonParaEnviar']").val(p_json_datos);

            modal.modal("show"); 
        }

        function obtenerDatos() 
        {
            return [
                { ncorr: 101, prelacion: 1, nombre: "Probando 1", descripcion: "Probando descripción 1", fecha: "07-11-2022", estado: "Activo" },
                { ncorr: 102, prelacion: 2, nombre: "Probando 2", descripcion: "Probando descripción 2", fecha: "07-11-2022", estado: "Inactivo" },
                { ncorr: 103, prelacion: 3, nombre: "Probando 3", descripcion: "Probando descripción 3", fecha: "07-11-2022", estado: "Activo" },
                { ncorr: 104, prelacion: 4, nombre: "Probando 4", descripcion: "Probando descripción 4", fecha: "07-11-2022", estado: "Inactivo" },
                { ncorr: 105, prelacion: 5, nombre: "Probando 5", descripcion: "Probando descripción 5", fecha: "07-11-2022", estado: "Activo" },
                { ncorr: 106, prelacion: 6, nombre: "Probando 6", descripcion: "Probando descripción 6", fecha: "07-11-2022", estado: "Inactivo" },
                { ncorr: 107, prelacion: 7, nombre: "Probando 7", descripcion: "Probando descripción 7", fecha: "07-11-2022", estado: "Activo" },
                { ncorr: 108, prelacion: 8, nombre: "Probando 8", descripcion: "Probando descripción 8", fecha: "07-11-2022", estado: "Activo" },
                { ncorr: 109, prelacion: 9, nombre: "Probando 9", descripcion: "Probando descripción 9", fecha: "07-11-2022", estado: "Activo" },
                { ncorr: 110, prelacion: 10, nombre: "Probando 10", descripcion: "Probando descripción 10", fecha: "07-11-2022", estado: "Activo" },
                { ncorr: 111, prelacion: 11, nombre: "Probando 11", descripcion: "Probando descripción 11", fecha: "07-11-2022", estado: "Activo" },
                { ncorr: 112, prelacion: 12, nombre: "Probando 12", descripcion: "Probando descripción 12", fecha: "07-11-2022", estado: "Activo" },
                { ncorr: 113, prelacion: 13, nombre: "Probando 13", descripcion: "Probando descripción 13", fecha: "07-11-2022", estado: "Activo" },
                { ncorr: 114, prelacion: 14, nombre: "Probando 14", descripcion: "Probando descripción 14", fecha: "07-11-2022", estado: "Activo" }
            ];
        }

        const limpiarFormulario = (querySelector) =>
        {
            Array.from($(querySelector).find(":input"))
                .filter(x => x.className.includes("form-control") && x.attributes.getNamedItem("no-limpiar") == null).forEach(x => {
                    x.value = "";
                });

            Array.from($(querySelector).find("select"))
                .filter(x => x.attributes.getNamedItem("no-limpiar") == null).forEach(x => {
                    $(`${querySelector} [name='${x.name}']`).find("option:first-child").prop("selected", true).trigger("chosen:updated");
                });
        };

        function quitarSeleccionSelect(querySelector) 
        {
            $(querySelector).find('option:first-child').prop('selected', true).end().trigger('chosen:updated');
        }

        function limpiarSelect(querySelector) 
        {
            $(querySelector + ' option[value!=""]').remove().end();    // Remueve todos los options excepto el seleccione
            $(querySelector).trigger("chosen:updated");
        }

        function llenarSelect(datos) 
        {
            if (Array.from($(datos.querySelector + ' option[value!=""]')).length)   // Si tiene elementos excepto el seleccione
                limpiarSelect(datos.querySelector);                              // Esto sirve al refrescar el combobox con nuevos datos

            quitarSeleccionSelect(datos.querySelector);

            if (datos.data != null) 
            {
                if (datos.selectedValue == null) 
                {
                    datos.data.forEach(c => {
                        $(datos.querySelector).append('<option value="' + c.codigo + '">' + c.descripcion + '</option>');
                    });
                }
                else 
                {
                    if (Array.isArray(datos.selectedValue)) {
                        var arreglo = datos.selectedValue;

                        datos.data.forEach(c => {
                            let selected = (arreglo.includes(c.codigo.toString())) ? "selected" : "";
                            $(datos.querySelector).append('<option value="' + c.codigo + '" ' + selected + '>' + c.descripcion + '</option>');

                        });
                    }
                    else {
                        datos.data.forEach(c => {
                            let selected = (c.codigo == datos.selectedValue) ? "selected" : "";
                            $(datos.querySelector).append('<option value="' + c.codigo + '" ' + selected + '>' + c.descripcion + '</option>');
                        });
                    }
                }

            }

            $(datos.querySelector).on("change", () => {
                if (datos.onchange != null && typeof datos.onchange === "function") datos.onchange();
            });

            $(datos.querySelector).trigger("chosen:updated");   // El select toma los cambios realizados

            if (datos.multiple != null && datos.multiple)   // Si es un select multiple, lo refresca
            {
                $(datos.querySelector).materialSelect("destroy");
                $(datos.querySelector).removeAttr("disabled");
            }
        }

        function showLoading() {
            $('#loadingOverlay').show();
        }

        function hideLoading() {
            $('#loadingOverlay').hide();
        }

        function validarNuloVacio(contenido)
        {
            if (contenido == null || contenido == "")
                return false;
            else
                return true;
        }

        /*
        DECLARE
            arreglo_recibido   json_array_t := json_array_t ( 
                '[
                    { "ncorr": null, "prelacion": 1, "nombre": "Probando 1", "descripcion": "Probando descripción 1", "fecha": "07-11-2022", "estado": "Activo" },
                    { "ncorr": 102, "prelacion": 2, "nombre": "Probando 2", "descripcion": "Probando descripción 2", "fecha": "07-11-2022", "estado": "Activo" }
                ]'
        );
        objeto   json_object_t;
        ncorr varchar(40); 
        prelación varchar(40);
        nombre varchar(40);
        descripcion varchar(40);
        fecha varchar(40);
        estado varchar(40);
        BEGIN
            DBMS_OUTPUT.put_line ('El número de elementos del arreglo es: ' || arreglo_recibido.get_size); 
            DBMS_OUTPUT.put_line('===============================>>>>>'); 

            FOR index_ele IN 0 .. arreglo_recibido.get_size - 1 LOOP 
            
                objeto := json_object_t (arreglo_recibido.get(index_ele));
                
                ncorr := replace(objeto.get('ncorr').to_string,'"','');
                prelación := replace(objeto.get('prelacion').to_string,'"','');
                nombre := replace(objeto.get('nombre').to_string,'"','');
                fecha := replace(objeto.get('fecha').to_string,'"','');
                estado := replace(objeto.get('estado').to_string,'"','');
                
                DBMS_OUTPUT.put_line('ncorr: ' || ncorr);
                DBMS_OUTPUT.put_line('prelación es: ' || prelación);
                DBMS_OUTPUT.put_line('nombre: ' || nombre);
                DBMS_OUTPUT.put_line('fecha: ' || fecha);
                DBMS_OUTPUT.put_line('estado: ' || estado);
                DBMS_OUTPUT.put_line('===============================>>>>>'); 
            END LOOP; 
        END;
        */

        //=====================================================================================>>>>>
        // Ejemplo funcionando:

        // var cadena = JSON.stringify(datos).split("\"").join("''");

/*
SET SERVEROUTPUT ON

DECLARE
    cadena varchar(5000) := '[{\"ncorr\":101,\"prelacion\":1,\"nombre\":\"Probando 1\",\"descripcion\":\"Probando descripción 1\",\"fecha\":\"07-11-2022\",\"estado\":\"Activo\"}]';
    nueva_cadena varchar(5000);
    arreglo   json_array_t;
    objeto   json_object_t;
    ncorr int; 
    prelación varchar(40);
    nombre varchar(40);
    descripcion varchar(40);
    fecha DATE;
    estado varchar(40);
    valor varchar(40);

    function obtenerValor(p_obj IN JSON_OBJECT_T, nombre varchar2) return varchar2 is 
        cadena varchar(80);
    begin 
       IF p_obj.has(nombre) AND p_obj.get(nombre) is not null THEN
            cadena := replace(p_obj.get(nombre).to_string, '"', '');
            return CASE 
                WHEN cadena <> 'null' THEN replace(p_obj.get(nombre).to_string, '"', '') 
                ELSE null 
            END;
       END IF;
       raise_application_error( -20001, 'No existe la key ' || nombre);
       return null; 
    end;
BEGIN
    
    -- nueva_cadena := replace(cadena,'''','"');   -- Reemplaza el  ''   por   "
    nueva_cadena := replace(cadena,'\"','"');   -- Reemplaza el  \"   por   "
    -- DBMS_OUTPUT.put_line(nueva_cadena);
    
    arreglo := json_array_t (nueva_cadena);
    DBMS_OUTPUT.put_line ('El número de elementos del arreglo es: ' || arreglo.get_size); 
    DBMS_OUTPUT.put_line('===============================>>>>>'); 

    FOR index_ele IN 0 .. arreglo.get_size - 1 LOOP 
    
        objeto := json_object_t (arreglo.get(index_ele));
        ncorr := TO_NUMBER(COALESCE(obtenerValor(objeto, 'ncorr'), '0'));
        prelación := obtenerValor(objeto, 'prelacion');
        nombre := obtenerValor(objeto, 'nombre');
        estado := obtenerValor(objeto, 'estado');
        
        valor := obtenerValor(objeto, 'fecha');
        fecha := CASE 
            WHEN valor is not null THEN TO_DATE(trim(valor), 'dd-mm-yyyy') 
            ELSE null 
        END;
        
        IF ncorr = 0 THEN  
            DBMS_OUTPUT.put_line('INSERT INTO EJEMPLO(ncorr, prelación, nombre, fecha, estado) 
            VALUES (EJEMPLO.NEXTVAL, ' || prelación || ', ' || nombre || ', ' || TO_CHAR(fecha, 'dd-mm-yyyy') || ', ' || estado || ');');
        ELSE  
            DBMS_OUTPUT.put_line('UPDATE EJEMPLO 
            SET prelacion = ' || prelación || ', nombre = ' || nombre || ', fecha = ' || TO_CHAR(fecha, 'dd-mm-yyyy') || ', estado = ' || estado || ' 
            WHERE ncorr = ' || ncorr);
        END IF;
        
        DBMS_OUTPUT.put_line('===============================>>>>>'); 
    END LOOP; 
    
    --raise_application_error( -20001, 'Probando error');
    DBMS_OUTPUT.put_line('COMMIT;'); 
    
EXCEPTION WHEN OTHERS THEN
    dbms_output.put_line( sqlerrm );
    DBMS_OUTPUT.PUT_LINE('ROLLBACK');
END;
*/

    </script>

</body>
</html>