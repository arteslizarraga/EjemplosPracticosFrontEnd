<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <style>
       
        table {
            border-collapse: collapse;
        }
        thead {
            background-color: lightgray;
        }

    </style>
</head>

<body>

    <br/><br/>

    <table width="100%" border="1">
        <thead>
            <tr>
                <th>Cliente</th>
                <th>Producto</th>
                <th>Cantidad</th>
                <th>Precio Unitario</th>
                <th>Sub Total (Sin Descuento)</th>
                <th>Descuento %</th>
                <th>Valor Descuento</th>
                <th>Sub Total con Descuento</th>
                <th>Total Venta (Sin Descuento)</th>
                <th>Total Venta (Con Descuento)</th>
                <th>IVA</th>
                <th>Suma Subtotales (Sin Descuentos)</th>
                <th>Total Recaudado (Con Descuentos)</th>
            </tr>
        </thead>
        <tbody id="contenido">
        </tbody>

    </table>

    <script>

        /*
        let ventas = [
            { 
                cliente: "José", 
                detalles: [
                    { producto: "COCA-COLA PET 250x12 PR", cantidad: 1, precioUnitario: 2016, descuento: 31.40 },
                    { producto: "FANTA PET PET 250x12 PROM", cantidad: 1, precioUnitario: 2016, descuento: 31.40 },
                    { producto: "COCA-COLA PET 500CC X12", cantidad: 1, precioUnitario: 3396, descuento: 17.40 },
                    { producto: "CC LIGTH PET 500CC X6 PR", cantidad: 2, precioUnitario: 1698, descuento: 17.40 },
                    { producto: "TRANSPORTE DE MERCADERIAS", cantidad: 1, precioUnitario: 770, descuento: 0 }
                ]
            }
        ];
        */    
       
        let ventas = [
            { 
                cliente: "José", 
                detalles: [
                    { producto: "Chocolate", cantidad: 1, precioUnitario: 1500, descuento: 0 }, 
                    { producto: "Galletas saladas", cantidad: 4, precioUnitario: 800, descuento: 0 },
                    { producto: "Papas fritas", cantidad: 1, precioUnitario: 2300, descuento: 0 }
                ]
            }, 
            { 
                cliente: "Juana", 
                detalles: [
                    { producto: "Agua mineral", cantidad: 2, precioUnitario: 1200, descuento: 20 }, 
                    { producto: "Bebida Energetica", cantidad: 3, precioUnitario: 3000, descuento: 0 },
                    { producto: "Azucar", cantidad: 1, precioUnitario: 1000, descuento: 0 }
                ]
            }
        ];


        const obtenerSumaSubtotalesSinDescuentos = () => ventas.map(
            venta => venta.detalles.map(detalle => detalle.precioUnitario * detalle.cantidad).reduce((a, b) => a + b, 0)
        ).reduce((a, b) => a + b, 0); 

        const obtenerPorcentaje = (numero, porcentaje) => 
        {
            let valorDescuento = (numero * porcentaje) / 100;
            return Math.round(valorDescuento);                  // Math.round convierte   633.0239999999999   en   633
        };

        const obtenerSumaSubtotalesConDescuentos = () =>
        {
            return ventas.map(
                venta => venta.detalles.map(detalle => 
                { 
                    let subTotal = detalle.precioUnitario * detalle.cantidad;
                    let valorDescuento = obtenerPorcentaje(subTotal, detalle.descuento);
                    return subTotal - valorDescuento;  // Sub Total con Descuento
                })
                .reduce((a, b) => a + b, 0)
            ).reduce((a, b) => a + b, 0);
        }

        const obtenerCantidadTotalDetalles = () => ventas.map(x => x.detalles.length).reduce((a, b) => a + b, 0); 

        let cadena = `

        ${ventas.map((venta, x) => 
        { 
            let totalVentaSinDescuentos = venta.detalles.map(x => x.precioUnitario * x.cantidad).reduce((a, b) => a + b, 0);

            let totalVentaConDescuentos = venta.detalles.map(x =>   // Este es el total neto
            { 
                let subTotalRecorrido = x.precioUnitario * x.cantidad;
                let valorDescuentoRecorrido = obtenerPorcentaje(subTotalRecorrido, x.descuento);
                return subTotalRecorrido - valorDescuentoRecorrido; 
            })
            .reduce((a, b) => a + b, 0);

            let porcentajeIVA = 18;   // Actualmente es el 19%
            let iva = (totalVentaConDescuentos * porcentajeIVA) / 100;
            iva = Math.round(iva);

            return `
            ${venta.detalles.map((detalle, y) => 
            { 
                let subTotal = detalle.precioUnitario * detalle.cantidad;
                let valorDescuento = obtenerPorcentaje(subTotal, detalle.descuento);

                return `
                <tr>
                    ${y == 0 ? ` 
                        <td rowspan="${venta.detalles.length}"> ${venta.cliente} </td>
                    ` : ""} 

                    <td> ${detalle.producto} </td>
                    <td> ${detalle.cantidad} </td>
                    <td> ${detalle.precioUnitario} </td>
                    <td> ${subTotal} </td>

                    <td> ${detalle.descuento} </td>

                    <td> ${valorDescuento} </td>
                    <td> ${subTotal - valorDescuento}  </td> <!-- Sub Total con Descuento -->

                    ${y == 0 ? ` 
                        <td rowspan="${venta.detalles.length}"> ${totalVentaSinDescuentos} </td>  <!-- Total Venta (Sin Descuento) -->

                        <td rowspan="${venta.detalles.length}"> ${totalVentaConDescuentos} </td>  <!-- Total Venta (Con Descuento) -->

                        <td rowspan="${venta.detalles.length}"> ${iva} </td>  <!-- IVA -->
                    ` : ""}  

                    ${x == 0 && y == 0 ? ` 
                        <td rowspan="${obtenerCantidadTotalDetalles()}"> ${obtenerSumaSubtotalesSinDescuentos()}</td>  <!-- Suma Subtotales (Sin Descuentos) -->

                        <td rowspan="${obtenerCantidadTotalDetalles()}"> ${obtenerSumaSubtotalesConDescuentos()}</td>  <!-- Total Recaudado (Con Descuentos) -->
                    ` : ""} 
                </tr>
                `;

            }).join("")} 
            `;

        }).join("")} 

        `;

        document.querySelector("#contenido").innerHTML = cadena;

        // //==================================>>>>>
        // // Probando

        // let subTotal = 2016;
        // let porcentajeDescuento = 31.40;
        // let totalConDescuento = (subTotal * porcentajeDescuento) / 100;

        // totalConDescuento = Math.round(totalConDescuento);      // 633.0239999999999
        // console.log("descuento", totalConDescuento);    // 633

        // //==================================>>>>>

    </script>

</body>

</html>