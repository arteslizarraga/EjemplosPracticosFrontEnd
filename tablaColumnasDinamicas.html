<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <style>
       
        /* table { border-collapse: collapse; text-align: left; }
        thead { background-color: lightgray; } */

        .tabla-info {
		  table-layout: fixed; 
		  width:100%;
		  border-collapse: collapse;
		}

		.tabla-info th, td {
		  border: 1px solid rgb(104, 103, 103);
		  word-wrap: break-word;         /* All browsers since IE 5.5+ */
		  overflow-wrap: break-word;     /* Renamed property in CSS3 draft spec */
		}

		.tabla-info td {
		  padding: 5px;
		}

		.tabla-info th {
		  white-space: nowrap;    /* Impide que haga un salto de linea  */
		  padding: 3px;
		}

		.tabla-info thead {
		  background-color: lightgray; 
          /* color: white; */
		}

    </style>
</head>

<body>

    <label>Ingrese nombre nueva Columna</label>
    <input type="text" id="inputNuevaColumna" />
    <button type="button" onclick="insertarNuevaColumna()">Insertar Columna</button>

    <br/><br/>
    
    <div id="formulario"></div>

    <br/><br/>

    <div id="contenido"></div>

    <script>

        let arreglo = [
            { codigo: "AAA1", nombre: "JosÃ©", apellido: "Lopez", edad: 33 }, 
            { codigo: "AAA2", nombre: "Juana", apellido: "Henriquez", edad: 21 },
            { codigo: "AAA3", nombre: "Andres", apellido: "Andrade", edad: 28 }
        ];

        let primeraPosicion = arreglo[0];

        let propiedadesDesplegadas = Object.keys(primeraPosicion).map((x, index) => {
            return { nombre: x, orden: (index + 1) };
        });

        const insertarNuevaColumna = () => 
        {
            let inputNuevaColumna = document.querySelector("#inputNuevaColumna");
            let nombreNuevaColumna = inputNuevaColumna.value;

            let nuevoArreglo = arreglo.map(x => {
                return {...x, [nombreNuevaColumna]: ""};
            });

            arreglo = nuevoArreglo;

            /*
            arreglo.push({
                codigo: arreglo.length > 0 ? ((arreglo.reduce((a, b) => (a.codigo > b.codigo) ? a : b).codigo) + 1) : 1,
                nombre: inputNuevaColumna.value 
            });
            */

            propiedadesDesplegadas.push({ 
                nombre: nombreNuevaColumna, 
                orden: ((propiedadesDesplegadas.reduce((a, b) => (a.orden > b.orden) ? a : b).orden) + 1) 
            });

            desplegarTabla();
            desplegarFormulario();
            inputNuevaColumna.value = "";
        }

        const actualizar = (codigo) => 
        {
            let elemento = arreglo.find(x => x.codigo == codigo);
            let nuevoNombrePrompt = prompt("Ingrese el nuevo nombre", elemento.nombre);

            if (nuevoNombrePrompt != null) {
                elemento.nombre = nuevoNombrePrompt;
                desplegarTabla();
            } 
        }

        const eliminar = (codigo) => 
        {
            arreglo = arreglo.filter(x => x.codigo != codigo);
            desplegarTabla();
        }

        const eliminarColumna = (orden) => 
        {
            let cont = 1;
            propiedadesDesplegadas = propiedadesDesplegadas.filter(x => x.orden != orden).sort((a, b) => a.orden - b.orden);

            propiedadesDesplegadas.forEach(x => {
                x.orden = cont;
                cont ++;
            });

            desplegarTabla();
            desplegarFormulario();
        };

        const desplegarTabla = () => 
        {
            let cadena = `
            <table class="tabla-info">
                <thead>
                    <tr>
                        <th style="width: 15px !important;"></th>
                        ${propiedadesDesplegadas.map(x => `<th>${x.orden}</th>`).join("")}
                        <th style="width: 140px !important;"></th>
                    </tr>
                    <tr>
                        <th></th>
                        ${propiedadesDesplegadas.map(x => {
                            return `<th>
                                ${x.nombre} &nbsp;&nbsp;
                                <button type="button" onclick="eliminarColumna(${x.orden})"> X </button>
                            </th>`;
                        }).join("")}

                        <th>Operaciones</th>
                    </tr>
                </thead>
                <tbody>
                    ${arreglo.map((elemento, index) => 
                    { 
                        return `
                        <tr>
                            <td style="background-color: lightgray;"> <b> ${index + 1} </b> </td>

                            ${propiedadesDesplegadas.map(x => `<td>${elemento[x.nombre]}</td>`).join("")}
                            <td> 
                                <button type="button" onclick="actualizar('${elemento.codigo}')">Actualizar</button>
                                <button type="button" onclick="eliminar('${elemento.codigo}')">Eliminar</button>
                            </td>
                        </tr>
                        `;
                    }).join("")} 
                </tbody>

            </table>
            `;

            document.querySelector("#contenido").innerHTML = cadena;
        }

        desplegarTabla();

        const desplegarFormulario = () => 
        {
            let cadena = `
            <h5> Formulario Ingreso <h5> 

            <form id="formularioIngreso">

                <table>
                    ${propiedadesDesplegadas.map(x => 
                    {
                        return `
                        <tr>
                            <td>${x.nombre}</td>
                            <td> <input type="text" name="${x.nombre}" /> </td>
                        </tr>
                        `;
                    })
                    .join("")}

                    <tr>
                        <td></td>
                        <td> <button type="button" onclick="insertarElementoEnArreglo()">Agregar Nuevo</button> </td>
                    </tr>
                </table>

            </form>
            `;
            
            document.querySelector("#formulario").innerHTML = cadena;
        };

        desplegarFormulario();

        const insertarElementoEnArreglo = () => 
        {
            let elemento = {};

            propiedadesDesplegadas.forEach(x => {
                elemento[x.nombre] = document.querySelector(`#formularioIngreso [name='${x.nombre}']`)?.value;
                document.querySelector(`#formularioIngreso [name='${x.nombre}']`).value = "";      // Limpia input
            });

            arreglo.push(elemento);
            desplegarTabla();
        };

    </script>

</body>

</html>